# DEPS — технология для описания зависимостей по БЭМ

Процесс сборки страницы в различных технологиях основан на описании БЭМ-сущностей в [БЭМ-дереве](https://ru.bem.info/methodology/key-concepts/#БЭМ-дерево).

Существует два способа формирования страницы:

* [Статический](#Статический-способ-формирования-страницы) — сборка страницы на основе описанного БЭМ-дерева.
* [Динамический](#Динамический-способ-формирования-страницы) — предварительная сборка статических файлов (CSS, JS, шаблоны), с последующим формированием в runtime динамического БЭМ-дерева.

## Статический способ формирования страницы

В случае сборки статической страницы БЭМ-дерево содержит все БЭМ-сущности, кроме блоков:
* [без DOM-представления](https://ru.bem.info/platform/i-bem/declaration/#Блоки-без-dom-представления);
* [разворачивающихся из шаблонов](https://ru.bem.info/platform/bem-xjst/).

Если в БЭМ-дереве указан какой-то блок, то в процессе сборки все необходимые для блока технологии (CSS, JS, BEMHTML, ...) будут автоматически собраны в общие файлы со всех уровней переопределения.

**Пример сборки статической страницы**

<img alt="Статический способ формирования страницы" src="https://rawgit.com/bem/bem-tools/godfreyd-deps/docs/depsjs/bem-static.svg" width="850.394px" height="524.409px" />

[Полный код примера](https://github.com/bem/project-stub/tree/static-bem-project).

## Динамический способ формирования страницы

При формировании динамической страницы на этапе сборки проекта БЭМ-дерево отсутствует. Поэтому необходимо задекларировать нужные БЭМ-сущности для предварительной генерации страницы.

**Пример сборки динамической страницы**

<img alt="Динамический способ формирования страницы" src="https://rawgit.com/bem/bem-tools/godfreyd-deps/docs/depsjs/bem-dynamic.svg" width="850.394px" height="807.874px" />

[Полный код примера](https://github.com/bem/bem-express/tree/dynamic-bem-project).

В обоих случаях для явного указания зависимостей от иных блоков, элементов, модификаторов и технологий используются файлы-технологии `deps.js`.

Например, шаблон `b1.bemhtml.js` содержит такой код:

```js
block('b1')(
    content()({
        block: 'b2'
    },{
        block: 'b3'
    })
);
```

Чтобы подключить на проект стили и скрипты блоков `b2` и `b3`, нам понадобится создать файл `b1.deps.js` такого содержания:

```js
/* b1 ---> b2;  b1 ---> b3 */
({
    mustDeps: { block: 'b2' },
    shouldDeps: { block: 'b3' }
})
```

Аналогично описываются зависимости для элементов и модификаторов, если они разнесены на файловой системе и не отражены во входящем BEMJSON-файле.

>Данный `/* b1 ---> b2 */` синтаксис в комментарии используется для короткой записи зависимостей. В данном случае стрелочка означает, что блок `b1` зависит от блока `b2`.

>Аналогично для элементов и модификаторов:
* `/* b1 ---> b1__e1 */` — блок `b1` зависит от своего элемента `b1__e1`;
* `/* b1 ---> b1__e1_m1_v1 */` — блок `b1` зависит от своего модификатора `b1__e1_m1_v1`.

>Зависимости по технологиям указываются в скобках:

>`/* b1(js) ---> b2(bemhtml) */` — блок `b1` в технологии реализации JavaScript зависит от блока `b2` в технологии реализации BEMHTML.

## Синтаксис DEPS

Формат представления DEPS-сущности в файле `deps.js` имеет следующий синтаксис:

```js
({
    /* DEPS-сущность */
})
```

DEPS-сущности в файле могут быть представлены в виде массива. Например, когда необходимо указать зависимость для конкретной технологии:

```js
([{
    /* DEPS-сущность №1 */
},{
    /* DEPS-сущность №2 */
}])
```

Полная запись DEPS-сущности имеет следующий вид:

```js
/* DEPS-сущность */
({
    block : 'block-name',
    elem  : 'elem-name',
    mod   : 'modName',
    val   : 'modValue',
    tech  : 'techName',
    mustDeps   : [ /* DEPS-сущность */ ],
    shouldDeps : [ /* DEPS-сущность */ ],
    noDeps     : [ /* DEPS-сущность */ ],
    include    : false
})
```

Все параметры DEPS-сущности не являются обязательными. При этом параметры `block`, `elem`, `mod`, `val`, `tech` указывают, для какой сущности/технологии необходимо подключить зависимость, а `mustDeps`, `shouldDeps`, `noDeps` определяют зависимость:

  * `block` (строка) — имя блока;
  * `elem` (строка) — имя элемента;
  * `mod` (строка) — имя модификатора;
  * `val` (строка) — значение модификатора блока;
  * `tech` (строка) — технология, для которой собираются зависимости (например, JS);
  * `mustDeps` (массив/объект) — определяются зависимости, которые гарантировано попадут в результаты сборки до кода БЭМ-сущности, в которой эти зависимости объявляются;
  * `shouldDeps` (массив/объект) — определяются зависимости, порядок подключения которых не важен;
  * `noDeps` (массив/объект) — можно отменить какую-то зависимость (например, `i-bem__dom_init_auto`).

Поля, относящиеся к сущности, для которой декларируется зависимость, могут быть восстановлены из контекста по имени файла, поэтому записи для файла `b1__e1_m1_v1.deps.js` эквивалентны:

```js
/* b1__e1_m1_v1 ---> b2 */
({
    block: 'b1',
    elem: 'e1',
    mod: 'm1',
    val: 'v1',
    mustDeps : { block : 'b2' }
})
```

```js
/* b1__e1_m1_v1 ---> b2 */
({
    mustDeps: { block: 'b2' }
})
```

Параметры `mustDeps`, `shouldDeps`, `noDeps` в качестве значения принимают БЭМ-сущности: `block`, `elem`, `mods`, или может использоваться расширенная запись БЭМ-сущностей, в которой элементы и модификаторы в качестве значения могут принимать массив:

* `elems` (массив) — позволяет подключить несколько элементов для блока, а также сам блок;
* `mods` (объект) — объект, в ключах которого могут быть массивы.

Для декларации зависимостей от БЭМ-сущностей, которые по тем или иным причинам не присутствовали на этапе сборки, необходимо объявить их в `mustDeps` или `shouldDeps`. Система сборки добавит эти объявления к плоскому списку `deps.js`-бандла,
на основании которого выполнится сборка технологий со всех уровней переопределений.

`noDeps` отменяет зависимости от более низких уровней переопределения до того уровня, на котором объявлен `noDeps`.

>См. также
>[Синтаксис и базовые типы данных](specification.ru.md)

## Механизм сборки

DEPS является технологией, которая подчиняется общим правилам сборки технологий в БЭМ.

По умолчанию файл с описанием зависимостей располагается в корневой директории блока и имеет имя блока с расширением `.deps.js`.

В `deps.js` можно определять зависимости от блоков, элементов и модификаторов для всех видов технологий.

Предположим, что в проекте есть следующие уровни переопределения: библиотека [bem-core](https://github.com/bem/bem-core), общие блоки, блоки платформы и блоки страницы:

```
project/
    libs/bem-core/common.blocks/
    common.blocks/
    desktop.blocks/
    desktop.bundles/page-name/blocks/
```

Указания в БЭМ-дереве `{ block: button }` достаточно, чтобы сборщик прошел по всем уровням переопределения проекта и подключил все соответствующие файлы:

```css
@import url(../../libs/bem-core/common.blocks/button/button.css);
@import url(../../common.blocks/button/button.css);
@import url(../../desktop.blocks/button/button.css);
@import url(blocks/button/button.css);
```

Сборка аналогична для любых других необходимых технологий (например, JS, шаблонов, документации и т.д.).

Предположим, в процессе исполнения БЭМ-дерево меняется, и в браузере блок `desktop.blocks/button` подключает элемент `e1` из блока `common.blocks/button`.

Запись такой зависимости в `desktop.blocks/button/button.deps.js` может выглядеть так:

```js
({
    shouldDeps : { block : 'button', elem : 'e1' }
})
```

В результате сборки технологии CSS на проекте будут подключены следующие файлы:

```css
@import url(../../libs/bem-core/common.blocks/button/button.css);
@import url(../../common.blocks/button/button.css);
@import url(../../desktop.blocks/button/button.css);
@import url(blocks/button/button.css);
@import url(../../common.blocks/button/__e1/button__e1.css);
@import url(../../desktop.blocks/button/__e1/button__e1.css);
@import url(blocks/button/__e1/button__e1.css);
```

По зависимости подключатся все задекларированные БЭМ-сущности, находящиеся как на нижних уровнях, так и на уровнях, которые будут выше.

## Примеры декларации зависимостей

### Подключение только элемента

`elem` подключает только элемент, но не сам блок.

Файл `b1.deps.js`:

```js
/* b1 ---> b1__e1 */
({
    shouldDeps : { block : 'b1', elem : 'e1' }
})
```

Аналогично для `mod` и `val`.

### Подключение нескольких элементов

Поведение `elems` немного отлично от `elem`, так как подключает вместе с элементами сам блок.

Файл `b1.deps.js`:

```js
/* b1 ---> b2; b1 ---> b2__e1 */
({
    shouldDeps : { block : 'b2', elems : ['e1'] }
})
```

Зависимости сами на себя (`b1 ---> b1`, `b2 ---> b2`) не имеют смысла и поэтому игнорируются.

Файл `b1.deps.js`:

```js
/* b1 ---> b1__e1 */
({
    shouldDeps : { block : 'b1', elems : ['e1'] }
})
```

Полe `elems` всегда раскрывается в `shouldDeps`, поэтому записи для файла `b1.deps.js` эквивалентны:

```js
/* b1 ---> b1__e1; b1 ---> b1__e2 */
({
    shouldDeps : { block : 'b1', elems : ['e1', 'e2'] }
})
```

```js
/* b1 ---> b1__e1; b1 ---> b1__e2 */
({
    block : 'b1',
    elems : ['e1', 'e2']
})
```

Значение ключа `elems` может содержать не только имя, но и полное описание подключаемых элементов:

```js
/* b1 ---> b1__e1; b1 ---> b1__e2; b1 ---> b1__e2_m1_v1 */
({
    block : 'b1',
    elems : [
        { elem : 'e1' },
        { elem : 'e2', mods : { m1 : 'v1' } }
    ]
})
```

### Подключение зависимостей по технологии

Подключение зависимостей по технологии (`depsByTech`) используется, например, для того, чтобы собрать в клиентский JavaScript-бандл шаблоны только тех блоков, которые будут использованы в браузере (предполагается, что при такой схеме часть шаблонизации происходит на стороне сервера и, следовательно, некоторые шаблоны на клиенте никогда не используются).

Для того, чтобы в сборку клиентского JavaScript попали шаблоны блока `b1` с модификатором `_m1_v1`, зависимости в `b1.deps.js`-файле можно выразить следующим образом:

```js
/* b1(js) ---> b1_m1_v1(bemhtml) */
({
    tech: 'js',
    mustDeps: [
        {
            block: 'b1',
            mods: { m1: 'v1' },
            tech: 'bemhtml'
        }
    ]
})
```
