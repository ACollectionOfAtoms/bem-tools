# DEPS

## Что такое зависимости

DEPS — это технология декларирования зависимостей при разработке БЭМ-проектов.

Существует два формата зависмостей:

* **Блочные** — описывают зависимости конкретной БЭМ-сущности от других блоков, элементов, модификаторов или технологий. Блочные зависимости указываются в файле `<bem-entity-name>.deps.js`, который создается в директории БЭМ-сущности на своем уровне переопределения.

* **Бандловые** — результат сборки всех блочных зависимостей, необходимых для работы бандла или страницы. Представляет собой плоский список без повторений БЭМ-сущностей. Бандловые завсимотсти хранятся в файле `<bandle-name>.deps.js` в результирующей директории. Подробно понятие бандловых зависимостей будет раскрыто в документации про сборку.

## Для чего нужны зависимости

В основе процесса сборки страницы лежит декларация БЭМ-сущностей в [БЭМ-дереве](#definitions/bem-tree). Способы сборки статической и динамической страницы отличаются:

* **Статическая** — полная сборка страницы и публикация готового результата. При формировании статической страницы БЭМ-дерево содержит все БЭМ-сущности, кроме блоков без DOM-представления и блоков, которые разворачиваются из шаблонов. Для попадания в сборку всех сущностей, не указанных в БЭМ-дереве, необходимо задекларировать их зависимости. 

* **Динамическая** — сборка проходит в два этапа: предварительная сборка статических файлов (CSS, JS, шаблонов) и формирование динамического БЭМ-дерева в runtime с применением шаблонов. Так как на этапе сборки проекта БЭМ-дерево отсутствует, для предварительной генерации страницы потребуется декларация всех необходимых БЭМ-сущностей на основе указанных зависимостей. 

В обоих случаях для явного указания зависимостей от иных блоков, элементов, модификаторов и технологий используются файлы технологии `deps.js`.

Например, шаблон `b1.bemhtml` содержит такой код:
```js
block b1, content: [
    {
        block: 'b2'
    },
    {
        block: 'b3'
    }
]
```

Чтобы подключить в проект стили и скрипты блоков `b2` и `b3`, необходимо создать файл `b1.deps.js` следующего содержания:
```js
({
    mustDeps: { block: 'b2' },
    shouldDeps: { block: 'b3' }
})
```

**Важно!** Если элементы и модификаторы блока разнесены по файловой системе и не отражены во входящем BEMJSON-файле, необходимо явно указывать их в зависимостях в файле `deps.js`.

## Синтаксис `deps.js`

Формат представления зависимостей в файле `deps.js` имеет следующий синтаксис:

```js
({
    /* БЭМ-сущность */
})
```

БЭМ-сущности в файле зависимостей могут быть представлены в виде массива. Например, когда необходимо указать зависимость для конкретной
технологии:
```js
([{
    /* БЭМ-сущность 1 */
},{
    /* БЭМ-сущность 2 */
}])
```

Полная запись зависимостей БЭМ-сущности имеет следующий вид:
```js
{
    block : 'bBlock',
    elem  : 'elem',
    mod   : 'modName',
    val   : 'modValue',
    tech  : 'techName',
    mustDeps   : [],
    shouldDeps : [],
    noDeps     : []
}
```

Все параметры не являются обязательными.

Следующие параемтры указывают, для какой сущности необходимо подключить зависимость:
  * `block` (строка) — имя блока;
  * `elem` (строка) — имя элемента;
  * `mod` (строка) — имя модификатора;
  * `val` (строка) — значение модификатора блока;
  * `tech` (строка) — технология, для которой собираются зависимости (например, JS).

Параметры `mustDeps`, `shouldDeps`, `noDeps` определяют степень зависимости.
  * `mustDeps` (массив/объект) — определяются зависимости, гарантированно попадающие в результаты сборки до кода
    блока, в котором эти зависимости объявляются.
  * `shouldDeps` (массив/объект) — определяются зависимости, порядок подключения которых не важен.
  * `noDeps` (массив/объект) — отменяется указанная зависимость (например, `i-bem__dom_init_auto`).

Поля, относящиеся к сущности, для которой декларируется зависимость, могут быть восстановлены из контекста по имени файла,
поэтому записи для файла `b1__e1_m1_v1.deps.js` эквивалентны:
```js
({
    block : 'b1',
    elem : 'e1',
    mod : 'm1',
    val : 'v1',
    mustDeps : { block : 'b2' }
})
```

```js
({
    mustDeps : { block : 'b2' }
})
```

Параметры `mustDeps`, `shouldDeps`, `noDeps` в качестве значения принимают БЭМ-сущности: `block`, `elem`, `mods`.
Также применяется расширенная запись БЭМ-сущностей, в которой элементы и модификаторы в качестве значения могут
принимать массив:
  * `elems` (массив) — позволяет подключить несколько элементов для блока, а также сам блок
  * `mods` (объект) — объект, в ключах которого могут быть массивы.

Для декларации зависимостей от БЭМ-сущностей, которые по тем или иным причинам не присутствовали на этапе сборки,
необходимо объявить их в `'mustDeps'` или `'shouldDeps'`. Система сборки добавит эти объявления к плоскому списку `deps.js`-бандла,
на основании которого выполнится сборка технологий со всех уровней переопределений.

`noDeps` отменяет зависимости от более низких уровней переопределения до того уровня, на котором объявлен `noDeps`.

### `mustDeps` или `shouldDeps`

`mustDeps` используется для определения зависимостей блока/элемента/модификатора, которые гарантировано должны попасть в сборку до объявления БЭМ-сущности, так как от этого зависит ее инициализация (например, блок `i-bem`).
`mustDeps` используется, если код зависимости должен примениться строго до кода БЭМ-сущности, у которой эти зависимости описаны.

`shouldDeps` используется для определения зависимостей, порядок подключения которых не важен. Это блоки, элементы, модификаторы и технологии, распределенные по файловой системе, которые использует БЭМ-сущность, но которые не прописаны в БЭМ-дереве.

## Использование `шоткатов`

```
({
    shouldDeps : [
        { elem : 'internal' },
        'inherit',
        'identify',
        'next-tick',
        'objects',
        'functions',
        'events'
    ]
})
```

## Механизм сборки

В предметной области БЭМ `deps.js` является технологией, которая подчиняется правилам сборки технологий.

По умолчанию файл с описанием зависимостей располагается в корневой директории блока и имеет имя блока с расширением `.deps.js`.

В `deps.js` можно определять зависимости от блоков, элементов и модификаторов для всех видов технологий.

Предположим, что в проекте есть четыре уровня переопределения: библиотека `bem-core`, общие блоки, блоки платформы и блоки
страницы:

```
prj/
    libs/bem-core/common.blocks/
    common.blocks/
    desktop.blocks/
    desktop.bundles/page-name/blocks/
```

Указания в БЭМ-дереве `'{ block: button }'` достаточно, чтобы сборщик прошел по всем уровням переопределения проекта и
подключил все соответствующие файлы:
```css
@import url(../../libs/bem-core/common.blocks/button/button.css);
@import url(../../common.blocks/button/button.css);
@import url(../../desktop.blocks/button/button.css);
@import url(blocks/button/button.css);
```
Сборка аналогична для любых других необходимых технологий (например, JS, шаблонов, документации и т.д.).

Предположим, в процессе исполнения БЭМ-дерево меняется и в браузере блок `desktop.blocks/button` подключает элемент `e1`
из блока `common.blocks/button`.

Запись такой зависимости в `desktop.blocks/button/button.deps.js` может выглядеть так:
```js
({
    shouldDeps : { block : 'button', elem : 'e1' }
})
```

В результате сборки технологии CSS на проекте будут подключены следующие файлы:
```css
@import url(../../libs/bem-core/common.blocks/button/button.css);
@import url(../../common.blocks/button/button.css);
@import url(../../desktop.blocks/button/button.css);
@import url(blocks/button/button.css);
@import url(../../common.blocks/button/__e1/button__e1.css);
@import url(../../desktop.blocks/button/__e1/button__e1.css);
@import url(blocks/button/__e1/button__e1.css);
```
По зависимости подключатся все задекларированные БЭМ-сущности, находящиеся как на нижних уровнях, так и на уровнях,
расположенных выше.

## Примеры декларации зависимостей

### Подключение только элемента

`elem` подключает только элемент, но не сам блок.
```js
{
    block : 'b1',
    elem : 'e1'
}
```

Аналогично для `mod` и `val`.

### Подключение нескольких элементов

Поведение `elems` немного отлично от `elem`, так как подключает вместе с элементами сам блок.
```js
{
    block : 'b1',
    elems : ['e1', 'e2']
}
```

Значение ключа `elems` может содержать не только имя, но и полное описание подключаемых элементов:
```js
{
    block : 'b1',
    elems : [
        { elem : 'e1' },
        { elem : 'e2', mods : { m1 : 'v1' } }
    ]
}
```

### Подключение зависимостей по технологии — depsByTech

В зависимости БЭМ-сущности могут быть подключены не только блоки, элементы, и модификаторы, но и их технологии реализации.

Для того, чтобы в сборку клиентского JS попали шаблоны блока `b1` с модификатром `_m1_v1`, зависимости в `deps.js`-файле
блока можно выразить следующим образом:
```js
{
    tech: 'js',
    mustDeps: [
        {
            block: 'b1',
            mods: { m1: 'v1' },
            tech: 'bemhtml'
        }
    ]
}
```
