# DEPS

## Что такое зависимости

DEPS — это технология декларирования зависимостей при разработке БЭМ-проектов. Она позволяет описывать зависимости БЭМ-сущности от других блоков, элементов, модификаторов или их технологий.

Зависимости указываются в файле `<bem-entity-name>.deps.js` (далее по тексту `deps.js`), который создается в директории БЭМ-сущности на необходимом уровне переопределения.

В `deps.js` можно определять зависимости от блоков, элементов и модификаторов для всех видов технологий.

## Для чего нужны зависимости

В основе процесса сборки страницы лежит декларация БЭМ-сущностей в [БЭМ-дереве](#definitions/bem-tree). Но в БЭМ-дереве не всегда явно прописаны все сущности, необходимые для генерации страницы.

При верстке статической страницы используется декларация, сформированная на основе БЭМ-дерева. Чтобы в декларацию попали БЭМ-сущности, явно не описанные в БЭМ-дереве (например, блоки без DOM-представления или сущности, подключаемые из шаблонов), необходимо указать их зависимости. 

При формировании динамического DOM-дерева в процессе исполнения, вызванном, например, действиями пользователя, для предварительной генерации страницы потребуется декларация всех необходимых БЭМ-сущностей на основе указанных зависимостей. 


//не разделять

* **Статическая** — полная сборка страницы и публикация готового результата. При формировании статической страницы БЭМ-дерево содержит все БЭМ-сущности, кроме блоков без DOM-представления и блоков, которые разворачиваются из шаблонов. Для попадания в сборку всех сущностей, не указанных в БЭМ-дереве, необходимо задекларировать их зависимости. 

* **Динамическая** — сборка проходит в два этапа: предварительная сборка статических файлов (CSS, JS, шаблонов) и формирование динамического БЭМ-дерева в runtime с применением шаблонов. Так как на этапе сборки проекта БЭМ-дерево отсутствует, для предварительной генерации страницы потребуется декларация всех необходимых БЭМ-сущностей на основе указанных зависимостей. 

В обоих случаях для явного указания зависимостей от иных блоков, элементов, модификаторов и технологий используются файлы технологии `deps.js`.

Например, шаблон `b1.bemhtml` содержит такой код:
```js
block(b1).content()function()  [
    {
        block: 'b2'
    },
    {
        block: 'b3'
    }
]
```

Чтобы подключить в проект стили и скрипты блоков `b2` и `b3`, необходимо создать файл `b1.deps.js` следующего содержания:
```js
({
    mustDeps: { block: 'b2' },
    shouldDeps: { block: 'b3' }
})
```

**Важно!** Если элементы и модификаторы блока разнесены по файловой системе и не отражены во входящем BEMJSON-файле, необходимо явно указывать их в зависимостях в файле `deps.js`.

## Синтаксис `deps.js`

Формат представления зависимостей в файле `deps.js` имеет следующий синтаксис:

```js
({
    /* deps-сущность */
})
```

deps-сущности в файле зависимостей могут быть представлены в виде массива. Например, когда необходимо указать зависимость для конкретной
технологии:
```js
{
    shouldDeps : [
        {
            /* deps-сущность 1 */
        },
        {
            /* deps-сущность 2 */
        }
    ]
}
```

shouldDeps : [
        { tech : 'bemhtml', block : 'button', mods : { type : 'link' } },
        { tech : 'bemhtml', block : 'icon' }
    ]
```

Полная запись deps-сущности имеет следующий вид:
```js
{
    block : 'bBlock',
    elem  : 'elem',
    mod   : 'modName',
    val   : 'modValue',
    tech  : 'techName',
    mustDeps   : [],
    shouldDeps : [],
    noDeps     : []
}
```
Достраивается по контексту, можно не прописывать. лежит в опред файле
Все параметры не являются обязательными.

Следующие параметры указывают, для какой сущности необходимо подключить зависимость:
  * `block` (строка) — имя блока;
  * `elem` (строка) — имя элемента;
  * `mod` (строка) — имя модификатора;
  * `val` (строка) — значение модификатора блока;
  * `tech` (строка) — технология, для которой собираются зависимости (например, JS).

Параметры `mustDeps`, `shouldDeps`, `noDeps` определяют тип зависимости:

* `mustDeps` (массив/объект/строка) — определяются зависимости, гарантированно попадающие в результаты сборки **до** кода
блока, в котором эти зависимости объявляются.
* `shouldDeps` (массив/объект/строка) — определяются зависимости, порядок подключения которых не важен.
* `noDeps` (массив/объект/строка) — отменяется указанная зависимость (например, `i-bem__dom_init_auto`). Зависимости можно отменять только на «нижние» уровни. При использовании `noDeps` для сущности, которая применяется во многих блоках, отмену зависимотси необходимо указывать для каждого блока.

Поля, относящиеся к сущности, для которой декларируется зависимость, могут быть восстановлены из контекста по имени файла,
поэтому записи для файла `b1__e1_m1_v1.deps.js` эквивалентны:
```js
({
    block : 'b1',
    elem : 'e1',
    mod : 'm1',
    val : 'v1',
    mustDeps : { block : 'b2' }
})
```

```js
({
    mustDeps : { block : 'b2' }
})
```

Параметры `mustDeps`, `shouldDeps`, `noDeps` в качестве значения принимают БЭМ-сущности: `block`, `elem`, `mods`.
Также применяется расширенная запись БЭМ-сущностей, в которой элементы и модификаторы в качестве значения могут
принимать массив:
  * `elems` (массив, сток, объектов, в кот могут быть массивы) — позволяет подключить несколько элементов для блока, а также сам блок
  * `mods` (объект) — объект, в значениях которого могут быть массивы.


Мы одной сущности добавляем сущности все
 Система сборки добавит эти объявления к плоскому списку `deps.js`-бандла,
на основании которого выполнится сборка технологий со всех уровней переопределений.

`noDeps` отменяет зависимости от более низких уровней переопределения до того уровня, на котором объявлен `noDeps`. сверху можно перебить, можно только для этой сущности, но не для других.

### Определения порядка зависимостей: `mustDeps` или `shouldDeps`

`mustDeps` используется, если код зависимости должен примениться строго до кода БЭМ-сущности, у которой эти зависимости описаны.

`mustDeps` используется для определения зависимостей блока/элемента/модификатора, которые гарантировано должны попасть в сборку до объявления БЭМ-сущности. Наприер, так как от этого можетзависит ее инициализация (например, блок `i-bem`) или стили должны перекрываться при миксе стилей.
пример мод кот переывается должен быть маст депс

во всех ост случаях используйте шуд депс
`shouldDeps` используется для определения зависимостей, порядок подключения которых не важен.

## Использование `шоткатов`

```
({
    shouldDeps : [
        { elem : 'internal' },
        'inherit',
        'identify'
    ]
})
```
пример с блоком и elems

## Механизм сборки

В предметной области БЭМ `deps.js` является технологией, которая подчиняется правилам сборки технологий.

//в диретории блока и имя файла
??По умолчанию файл с описанием зависимостей располагается в корневой директории блока и имеет имя блока с расширением `.deps.js`.


Предположим, что в проекте есть четыре уровня переопределения: библиотека `bem-core`, общие блоки, блоки платформы и блоки
страницы:

```
prj/
    libs/bem-core/common.blocks/
    common.blocks/
    desktop.blocks/
    desktop.bundles/page-name/blocks/
```

Указания в БЭМ-дереве `{ block: 'button' }` достаточно, чтобы сборщик прошел по всем уровням переопределения проекта и
подключил все соответствующие файлы:
```css
@import url(../../libs/bem-core/common.blocks/button/button.css);
@import url(../../common.blocks/button/button.css);
@import url(../../desktop.blocks/button/button.css);
@import url(blocks/button/button.css);
```
Сборка аналогична для любых других необходимых технологий (например, JS, шаблонов, документации и т.д.).

Предположим, в процессе исполнения в качестве реакции на действия пользователя будет меняться dom-дерево и в браузере блок `desktop.blocks/button` подключает элемент `e1` (икноку)
из блока `common.blocks/button`.

Запись такой зависимости в `desktop.blocks/button/button.deps.js` может выглядеть так:
```js
({
    shouldDeps : { block : 'button', elem : 'e1' }
})
```

В результате сборки технологии CSS на проекте будут подключены следующие файлы:
```css
@import url(../../libs/bem-core/common.blocks/button/button.css);
@import url(../../common.blocks/button/button.css);
@import url(../../desktop.blocks/button/button.css);
@import url(blocks/button/button.css);
@import url(../../common.blocks/button/__e1/button__e1.css);
@import url(../../desktop.blocks/button/__e1/button__e1.css);
@import url(blocks/button/__e1/button__e1.css);
```
По зависимости подключатся все задекларированные БЭМ-сущности, находящиеся как на нижних уровнях, так и на уровнях,
расположенных выше.

## Примеры декларации зависимостей

### Подключение только элемента

`elem` подключает только элемент, но не сам блок.
```js
shouldDeps
{
    block : 'b1',
    elem : 'e1'
}
```

Аналогично для `mod` и `val`.

### Подключение нескольких элементов

Поведение `elems` отлично от `elem`, так как подключает вместе с элементами сам блок.
```js
{
    block : 'b1',
    elems : ['e1', 'e2']
}
```

Значение ключа `elems` может содержать не только имя, но и полное описание подключаемых элементов:
```js
{
    block : 'b1',
    elems : [
        { elem : 'e1' },
        { elem : 'e2', mods : { m1 : 'v1' } }
    ]
}
```

//подключение модификаторов

### Подключение зависимостей по технологии — depsByTech

все что вы до этого читали - эта сущность во всех своих технологиях зависит от всех технологий др сущности. Но можно делать точеченые зависимости конкретной технологии одного блока от другой технологии др блока.

зависимости

указать конкретную технологию конкретной БЁ

В зависимости БЭМ-сущности могут быть подключены не только блоки, элементы, и модификаторы, но и их технологии реализации.

Для того, чтобы в сборку клиентского JS попали шаблоны блока `b1` с модификатром `_m1_v1`, зависимости в `deps.js`-файле
блока можно выразить следующим образом:
```js
{
    tech: 'js',
    mustDeps: [
        {
            block: 'b1',
            mods: { m1: 'v1' },
            tech: 'bemhtml'
        }
    ]
}
```
технолоигия джс данного блока завист от шаблона б1 и
